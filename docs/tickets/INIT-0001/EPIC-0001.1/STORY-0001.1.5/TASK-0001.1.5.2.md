# TASK-0001.1.5.2: Create documentation directory structure and validation framework

**Parent Story**: [STORY-0001.1.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 4
**Actual Hours**: -

## Objective

Create skills/gitstory/references/ directory structure and implement documentation validation framework with markdown linting and link validation. Foundation task that enables documentation creation in subsequent tasks.

## BDD Progress

**Before this task**: 0/8 scenarios passing
**After this task**: 2/8 scenarios passing

**Scenarios for this task:**

- Scenario 1: Reference documentation available in skills/gitstory/references/ (FULL - directory structure)
- Scenario 7: Documentation cross-references work correctly (PARTIAL - validation framework only)

## Implementation Checklist

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/documentation/test_validator.py`
- [ ] Write test for markdown syntax validation (3+ tests):
  - [ ] Test: Valid markdown parses without errors
  - [ ] Test: Invalid markdown raises specific errors
  - [ ] Test: Headers follow hierarchy (H1 â†’ H2 â†’ H3, no skips)
- [ ] Write test for link validation (3+ tests):
  - [ ] Test: {baseDir} links resolve correctly
  - [ ] Test: Relative links validate against filesystem
  - [ ] Test: Broken links detected and reported
- [ ] Write test for YAML validation (2+ tests):
  - [ ] Test: YAML code blocks parse correctly
  - [ ] Test: Invalid YAML detected with line numbers
- [ ] Run tests - all fail âœ“

### Implementation (GREEN)

#### Create Directory Structure

- [ ] Create `skills/gitstory/references/` directory:
  ```bash
  mkdir -p skills/gitstory/references
  ```
- [ ] Create placeholder `.gitkeep` file to preserve directory

#### Documentation Validator

- [ ] Create `src/gitstory/documentation/validator.py`:
  ```python
  from pathlib import Path
  import re
  import yaml
  from markdown_it import MarkdownIt

  class DocumentationValidator:
      """Validate documentation markdown files."""

      def __init__(self, base_dir: Path):
          self.base_dir = base_dir
          self.md = MarkdownIt()

      def validate_markdown(self, file_path: Path) -> list[str]:
          """Validate markdown syntax and structure.

          Returns:
              List of validation errors (empty if valid)
          """
          errors = []
          content = file_path.read_text()

          # Parse markdown
          try:
              tokens = self.md.parse(content)
          except Exception as e:
              errors.append(f"Markdown parsing failed: {e}")
              return errors

          # Validate header hierarchy
          header_levels = [t.tag for t in tokens if t.type == "heading_open"]
          errors.extend(self._validate_header_hierarchy(header_levels))

          # Validate links
          errors.extend(self._validate_links(content, file_path))

          # Validate YAML code blocks
          errors.extend(self._validate_yaml_blocks(content))

          return errors

      def _validate_header_hierarchy(self, levels: list[str]) -> list[str]:
          """Check headers don't skip levels (h1 â†’ h3 without h2)."""
          errors = []
          prev_level = 0
          for level_tag in levels:
              level = int(level_tag[1])  # Extract number from h1, h2, etc.
              if level > prev_level + 1:
                  errors.append(
                      f"Header hierarchy skip: jumped from h{prev_level} to h{level}"
                  )
              prev_level = level
          return errors

      def _validate_links(self, content: str, source_file: Path) -> list[str]:
          """Validate internal links resolve correctly."""
          errors = []

          # Find all markdown links: [text](url)
          link_pattern = r'\[([^\]]+)\]\(([^\)]+)\)'
          for match in re.finditer(link_pattern, content):
              url = match.group(2)

              # Skip external links
              if url.startswith(('http://', 'https://')):
                  continue

              # Handle {baseDir} substitution
              if '{baseDir}' in url:
                  url = url.replace('{baseDir}', str(self.base_dir))

              # Resolve relative path
              target = (source_file.parent / url).resolve()

              if not target.exists():
                  errors.append(f"Broken link: {url} (target not found)")

          return errors

      def _validate_yaml_blocks(self, content: str) -> list[str]:
          """Validate YAML code blocks parse correctly."""
          errors = []

          # Find YAML code blocks: ```yaml ... ```
          yaml_pattern = r'```yaml\n(.*?)\n```'
          for i, match in enumerate(re.finditer(yaml_pattern, content, re.DOTALL), 1):
              yaml_content = match.group(1)
              try:
                  yaml.safe_load(yaml_content)
              except yaml.YAMLError as e:
                  errors.append(f"YAML block {i} invalid: {e}")

          return errors
  ```
- [ ] Add logging for validation results
- [ ] Run tests - all pass âœ“

### BDD Implementation (Scenarios 1, 7 partial)

- [ ] Implement step: "Given the GitStory skill directory structure"
- [ ] Implement step: "When I check skills/gitstory/references/"
- [ ] Implement step: "Then workflow-schema.md exists" (will fail until TASK-3)
- [ ] Implement step: "And all documentation files have .md extension"
- [ ] Implement step: "Given documentation with {baseDir} links"
- [ ] Implement step: "When validating cross-references"
- [ ] Implement step: "Then {baseDir} substitutes skill directory path correctly"
- [ ] Run BDD tests - Scenarios 1 (partial), 7 (partial) pass (2/8 passing) âœ“

### Verification

- [ ] All unit tests pass (8+ tests, 100% coverage for validator.py)
- [ ] BDD Scenarios 1, 7 partially passing (2/8 passing)
- [ ] Directory skills/gitstory/references/ created
- [ ] Documentation validator validates markdown, links, YAML
- [ ] Error messages include file paths and line numbers

## Files to Create/Modify

- CREATE: `skills/gitstory/references/.gitkeep` (preserve empty directory)
- CREATE: `src/gitstory/documentation/validator.py` (~150 lines, validation logic)
- CREATE: `tests/unit/documentation/test_validator.py` (~180 lines, 8+ tests)
- MODIFY: `tests/e2e/steps/test_documentation.py` (implement steps for Scenarios 1, 7 partial)

## Pattern Reuse

- `Markdown parsing with markdown-it` (Python markdown-it-py package) - Parse and validate markdown structure
- `YAML validation pattern` (from STORY-0001.1.3, STORY-0001.1.4) - Reuse yaml.safe_load() with error handling

## Dependencies

- TASK-0001.1.5.1 complete (BDD scenarios stubbed)
- markdown-it-py package installed (add to pyproject.toml)

## Edge Cases Handled

- Missing references/ directory (create with mkdir -p)
- Invalid markdown syntax (report with line numbers)
- Broken internal links (detect and report path)
- External links (skip validation, assume valid)
- {baseDir} variable in links (substitute correctly)
- YAML blocks with syntax errors (report block number)
- Header hierarchy violations (detect level skips)

## Success Criteria

- [ ] Directory structure created
- [ ] All unit tests passing (8+ tests)
- [ ] Validation framework detects broken links
- [ ] Validation framework validates YAML blocks
- [ ] BDD Scenarios 1, 7 partially passing (2/8)
