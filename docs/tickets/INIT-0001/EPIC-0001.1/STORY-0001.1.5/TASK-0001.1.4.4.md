# TASK-0001.1.4.4: Create example configs and implement lookup priority

**Parent Story**: [STORY-0001.1.4](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 5
**Actual Hours**: -

## Objective

Create 3 complete example command configuration files (plan.yaml, review.yaml, install.yaml) and implement 3-tier configuration lookup priority (project â†’ user â†’ skill). Integration task that completes all remaining BDD scenarios.

## BDD Progress

**Before this task**: 5/7 scenarios passing
**After this task**: 7/7 scenarios passing âœ…

**Scenarios for this task:**

- Scenario 2: Command configuration includes name, description, triggers, steps (FULL - example configs)
- Scenario 5: Command configuration lookup priority (FULL - priority cascade)
- Scenario 6: Commands integrate with templates (FULL - template integration)

## Implementation Checklist

### Create Example Configuration Files

#### plan.yaml (Story Planning Command)

- [ ] Create `skills/gitstory/commands/plan.yaml`:
  ```yaml
  name: "Plan Story"
  description: "Define tasks for a story with incremental BDD tracking"
  version: "1.0.0"

  triggers:
    - type: "pattern"
      value: "^/gitstory:plan\\s+STORY-\\d{4}\\.\\d+\\.\\d+$"
      description: "/gitstory:plan STORY-0001.1.2"
    - type: "keyword"
      value: "plan story"
      case_insensitive: true
      description: "Natural language: 'plan this story'"
    - type: "ticket_id"
      value: "STORY-*"
      description: "Ticket ID pattern matching"

  variables:
    - name: "ticket_id"
      source: "trigger_match"
      pattern: "STORY-\\d{4}\\.\\d+\\.\\d+"
      description: "Extracted from trigger"
    - name: "branch_name"
      source: "git"
      command: "git rev-parse --abbrev-ref HEAD"
      description: "Current git branch"
    - name: "user_input"
      source: "conversation"
      description: "User-provided context"

  steps:
    - action: "extract_ticket"
      input: "{ticket_id}"
      description: "Load ticket file from docs/tickets/"
      output: "ticket_content"

    - action: "load_template"
      input: "story"
      description: "Load story template"
      output: "template_content"

    - action: "interview_user"
      input:
        - "How many tasks for this story? (2-6)"
        - "What are key implementation steps?"
      description: "Gather task requirements"
      output: "user_requirements"

    - action: "generate_tasks"
      input: "{ticket_content}, {template_content}, {user_requirements}"
      description: "Generate task breakdown"
      output: "task_definitions"

    - action: "update_ticket"
      input: "{ticket_id}, {task_definitions}"
      description: "Update story README"
      output: "updated_ticket"

  response_template: |
    Created tasks for {ticket_id}:
    {task_definitions}

    Next: git checkout -b {branch_name}
  ```

#### review.yaml (Story Quality Review Command)

- [ ] Create `skills/gitstory/commands/review.yaml`:
  ```yaml
  name: "Review Story Quality"
  description: "Validate story specification and score quality"
  version: "1.0.0"

  triggers:
    - type: "pattern"
      value: "^/gitstory:review\\s+(STORY|EPIC|INIT)-\\d{4}"
      description: "/gitstory:review STORY-0001.1.2"
    - type: "keyword"
      value: "review story quality"
      case_insensitive: true
      description: "Natural language trigger"

  variables:
    - name: "ticket_id"
      source: "trigger_match"
      description: "Ticket to review"
    - name: "quality_score"
      source: "git_command"
      description: "Calculated quality percentage"

  steps:
    - action: "validate_specification"
      input: "{ticket_id}"
      description: "Check for vague terms, missing criteria"
      output: "validation_report"

    - action: "check_bdd_scenarios"
      input: "{ticket_id}"
      description: "Validate BDD completeness"
      output: "bdd_report"

    - action: "score_quality"
      input: "{validation_report}, {bdd_report}"
      description: "Calculate 0-100% quality score"
      output: "quality_score"

  response_template: |
    Quality Score: {quality_score}%

    Issues Found:
    {validation_report}

    Recommendations:
    {bdd_report}
  ```

#### install.yaml (Installation Command)

- [ ] Create `skills/gitstory/commands/install.yaml`:
  ```yaml
  name: "Install GitStory"
  description: "Configure GitStory skill for project"
  version: "1.0.0"

  triggers:
    - type: "pattern"
      value: "^/gitstory:install"
      description: "/gitstory:install"
    - type: "keyword"
      value: "install gitstory"
      case_insensitive: true

  variables:
    - name: "installation_path"
      source: "git"
      command: "pwd"
      description: "Current working directory"
    - name: "os_type"
      source: "git"
      command: "uname -s"
      description: "Operating system"

  steps:
    - action: "detect_environment"
      input: "{os_type}"
      description: "Check OS and project structure"
      output: "environment"

    - action: "create_directories"
      input: "{installation_path}/.gitstory"
      description: "Create .gitstory/ directory"
      output: "directories_created"

    - action: "configure_overrides"
      input: "{installation_path}/.gitstory/templates/"
      description: "Set up template overrides"
      output: "config_status"

  response_template: |
    GitStory installed at: {installation_path}

    Created directories:
    - .gitstory/templates/
    - .gitstory/commands/

    OS: {os_type}
    Status: {config_status}
  ```

### Unit Tests for Lookup Priority (TDD - RED)

- [ ] Create `tests/unit/commands/test_config_loader.py`
- [ ] Write test for project override (highest priority) - 2+ tests
- [ ] Write test for user override (medium priority) - 2+ tests
- [ ] Write test for skill default (fallback) - 2+ tests
- [ ] Write test for missing config at all levels - 1 test
- [ ] Write test for invalid YAML in override - 1 test
- [ ] Run tests - all fail âœ“

### Implementation (GREEN) - Config Loader

- [ ] Create `src/gitstory/commands/config_loader.py`:
  ```python
  from pathlib import Path
  from typing import Optional

  class ConfigLoader:
      """Load command configurations with 3-tier priority."""

      def __init__(self, base_dir: Optional[Path] = None):
          """Initialize with skill base directory."""
          if base_dir is None:
              # Default to package location
              base_dir = Path(__file__).parent.parent.parent / "skills" / "gitstory"
          self.base_dir = base_dir

      def find_config(self, command_name: str) -> Path:
          """Find command config with priority: project â†’ user â†’ skill.

          Args:
              command_name: Command name (e.g., "plan", "review")

          Returns:
              Path to first matching config file

          Raises:
              FileNotFoundError: If config not found at any level
          """
          config_file = f"{command_name}.yaml"

          # Level 1: Project override (.gitstory/commands/)
          project_config = Path.cwd() / ".gitstory" / "commands" / config_file
          if project_config.exists():
              return project_config

          # Level 2: User override (~/.claude/skills/gitstory/commands/)
          user_config = Path.home() / ".claude" / "skills" / "gitstory" / "commands" / config_file
          if user_config.exists():
              return user_config

          # Level 3: Skill default (skills/gitstory/commands/)
          skill_config = self.base_dir / "commands" / config_file
          if skill_config.exists():
              return skill_config

          raise FileNotFoundError(
              f"Command config '{command_name}' not found in:\n"
              f"  1. {project_config} (project)\n"
              f"  2. {user_config} (user)\n"
              f"  3. {skill_config} (skill)"
          )

      def load_config(self, command_name: str) -> CommandConfig:
          """Load and parse command configuration.

          Returns:
              Parsed CommandConfig object
          """
          config_path = self.find_config(command_name)

          from .yaml_parser import parse_command_config
          return parse_command_config(config_path)
  ```
- [ ] Add logging for which config level was used
- [ ] Run tests - all pass âœ“

### BDD Implementation (Scenarios 2, 5, 6)

- [ ] Implement step: "Given skills/gitstory/commands/plan.yaml"
- [ ] Implement step: "When I parse the YAML structure"
- [ ] Implement step: "Then it includes name, description, triggers, steps"
- [ ] Implement step: "And each trigger has type and value"
- [ ] Implement step: "Given .gitstory/commands/custom-plan.yaml (project override)"
- [ ] Implement step: "And ~/.claude/skills/gitstory/commands/plan.yaml (user override)"
- [ ] Implement step: "And {baseDir}/commands/plan.yaml (skill default)"
- [ ] Implement step: "When loading plan command configuration"
- [ ] Implement step: "Then project override is checked first"
- [ ] Implement step: "Given plan.yaml command and story.md template"
- [ ] Implement step: "When plan command executes"
- [ ] Implement step: "Then it can reference template fields"
- [ ] Run BDD tests - ALL 7 scenarios pass âœ…

### Integration Testing

- [ ] Create example project override: `.gitstory/commands/plan-custom.yaml`
- [ ] Test priority cascade with real filesystem paths
- [ ] Test with symlinks (user â†’ project, project â†’ skill)
- [ ] Test integration with template system (from STORY-0001.1.3)
- [ ] Verify all 8 acceptance criteria:
  - [ ] Command directory structure created âœ“
  - [ ] 3+ examples implemented âœ“
  - [ ] Command schema documented âœ“
  - [ ] YAML syntax validated âœ“
  - [ ] Lookup priority verified âœ“
  - [ ] Variable substitution documented âœ“
  - [ ] Integration points documented âœ“
  - [ ] All configs render correctly âœ“

### Documentation

- [ ] Create `skills/gitstory/commands/README.md` with:
  - [ ] Command configuration schema reference
  - [ ] Trigger types and examples
  - [ ] Variable sources and substitution patterns
  - [ ] Step actions registry
  - [ ] Lookup priority diagram
  - [ ] Integration with templates explanation
- [ ] Add usage examples to each command YAML file (as comments)

### Verification

- [ ] All unit tests pass (5+ tests, 100% coverage for config_loader.py)
- [ ] All BDD scenarios pass (7/7 passing âœ…)
- [ ] All 3 example configs parse without errors
- [ ] Config lookup follows documented priority order
- [ ] Template integration works correctly
- [ ] All acceptance criteria verified

## Files to Create/Modify

- CREATE: `skills/gitstory/commands/plan.yaml` (~60 lines, complete example)
- CREATE: `skills/gitstory/commands/review.yaml` (~50 lines, complete example)
- CREATE: `skills/gitstory/commands/install.yaml` (~50 lines, complete example)
- CREATE: `skills/gitstory/commands/README.md` (~200 lines, documentation)
- CREATE: `src/gitstory/commands/config_loader.py` (~100 lines, lookup logic)
- CREATE: `tests/unit/commands/test_config_loader.py` (~120 lines, 5+ tests)
- MODIFY: `tests/e2e/steps/test_command_configuration.py` (implement steps for Scenarios 2, 5, 6)
- MODIFY: `docs/tickets/INIT-0001/EPIC-0001.1/STORY-0001.1.4/README.md` (update progress to 100%)

## Pattern Reuse

- `Priority cascade file lookup` (from STORY-0001.1.3) - Same 3-tier pattern: project â†’ user â†’ skill

## Integration Points

### With Templates (STORY-0001.1.3)

Commands can reference template fields using variable substitution:

```yaml
variables:
  - name: "story_points"
    source: "template"
    path: "story_points"

steps:
  - action: "validate_estimate"
    input: "{story_points}"
    description: "Check if story points match task hours"
```

### With SKILL.md (STORY-0001.1.2)

Commands are invoked by SKILL.md skill processor when triggers match user input.

## Edge Cases Handled

- Missing .gitstory/ directory (skip gracefully)
- Missing ~/.claude/ directory (skip gracefully)
- Permission denied on config directory (clear error message)
- Invalid YAML in override file (raise error with path and line number)
- Circular command dependencies (detect and raise error)
- Template field not found (log warning, substitute with empty string)

## Success Criteria

- [ ] All 7 BDD scenarios passing âœ…
- [ ] All unit tests passing (5+ tests)
- [ ] 3 complete example configs created
- [ ] Configuration lookup documented with examples
- [ ] Template integration working
- [ ] All acceptance criteria verified
- [ ] Story marked 100% complete
