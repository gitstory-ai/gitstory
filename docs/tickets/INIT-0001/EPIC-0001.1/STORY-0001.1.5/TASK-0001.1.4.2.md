# TASK-0001.1.4.2: Create command directory structure and YAML schemas

**Parent Story**: [STORY-0001.1.4](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 4
**Actual Hours**: -

## Objective

Create skills/gitstory/commands/ directory and define command schema models with YAML validation. Foundation task that implements core schema infrastructure with comprehensive unit tests.

## BDD Progress

**Before this task**: 0/7 scenarios passing
**After this task**: 2/7 scenarios passing

**Scenarios for this task:**

- Scenario 1: Command configuration examples available (FULL - directory structure)
- Scenario 7: Command configuration syntax validates with Python YAML parser (FULL - validation)

## Implementation Checklist

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/commands/test_schemas.py`
- [ ] Write tests for CommandConfig dataclass (3+ tests: required fields, types, validation)
- [ ] Write tests for Trigger dataclass (3+ tests: type enum, value patterns, case sensitivity)
- [ ] Write tests for Variable dataclass (2+ tests: source types, substitution patterns)
- [ ] Write tests for Step dataclass (2+ tests: action types, input/output)
- [ ] Write tests for YAML parsing (3+ tests: valid/invalid YAML, missing fields)
- [ ] Run tests - all fail âœ“

### Implementation (GREEN)

- [ ] Create `skills/gitstory/commands/` directory with `mkdir -p`
- [ ] Create `src/gitstory/commands/schemas.py` with dataclasses:
  ```python
  @dataclass
  class Trigger:
      type: Literal["pattern", "keyword", "ticket_id"]
      value: str
      description: str
      case_insensitive: bool = False

  @dataclass
  class Variable:
      name: str
      source: Literal["trigger_match", "git", "conversation", "git_command", "template"]
      description: str
      pattern: Optional[str] = None
      command: Optional[str] = None
      path: Optional[str] = None

  @dataclass
  class Step:
      action: str
      input: Union[str, dict, list]
      description: str
      output: Optional[str] = None
      condition: Optional[str] = None

  @dataclass
  class CommandConfig:
      name: str
      description: str
      version: str
      triggers: list[Trigger]
      variables: list[Variable]
      steps: list[Step]
      response_template: Optional[str] = None
  ```
- [ ] Create `src/gitstory/commands/yaml_parser.py`:
  ```python
  def parse_command_config(path: Path) -> CommandConfig:
      """Parse command YAML file into CommandConfig object."""
      with open(path) as f:
          data = yaml.safe_load(f)

      # Validate required fields
      required = {"name", "description", "triggers", "steps"}
      if not required.issubset(data.keys()):
          missing = required - data.keys()
          raise ValueError(f"Missing required fields: {missing}")

      # Parse triggers
      triggers = [Trigger(**t) for t in data["triggers"]]

      # Parse variables (optional)
      variables = [Variable(**v) for v in data.get("variables", [])]

      # Parse steps
      steps = [Step(**s) for s in data["steps"]]

      return CommandConfig(
          name=data["name"],
          description=data["description"],
          version=data.get("version", "1.0.0"),
          triggers=triggers,
          variables=variables,
          steps=steps,
          response_template=data.get("response_template")
      )
  ```
- [ ] Add error handling for YAML syntax errors with line numbers
- [ ] Add validation for enum types (trigger type, variable source)
- [ ] Run tests - all pass âœ“

### BDD Implementation (Scenarios 1, 7)

- [ ] Implement step: "Given the GitStory skill directory structure"
- [ ] Implement step: "When I check skills/gitstory/commands/"
- [ ] Implement step: "Then plan.yaml configuration exists"
  - [ ] Will fail until TASK-4 creates actual configs
- [ ] Implement step: "Given all command configurations"
- [ ] Implement step: "When parsing with yaml.safe_load()"
- [ ] Implement step: "Then YAML syntax is valid (no parsing errors)"
- [ ] Implement step: "And all required fields present"
- [ ] Run BDD tests - Scenarios 1, 7 pass (directory exists, parser works) âœ“

### Verification

- [ ] All unit tests pass (10+ tests, 100% coverage for schemas.py and yaml_parser.py)
- [ ] BDD Scenarios 1, 7 passing (2/7 passing)
- [ ] Directory skills/gitstory/commands/ exists
- [ ] YAML parser validates required fields
- [ ] Schema models enforce type constraints

## Files to Create/Modify

- CREATE: `skills/gitstory/commands/` (directory)
- CREATE: `src/gitstory/commands/schemas.py` (~120 lines, dataclasses)
- CREATE: `src/gitstory/commands/yaml_parser.py` (~80 lines, parser + validation)
- CREATE: `tests/unit/commands/test_schemas.py` (~150 lines, 10+ tests)
- MODIFY: `tests/e2e/steps/test_command_configuration.py` (implement steps for Scenarios 1, 7)

## Pattern Reuse

- `YAML frontmatter parsing with validation` (from STORY-0001.1.3) - Reuse yaml.safe_load() pattern with schema validation

## Edge Cases Handled

- Missing required fields (raise ValueError with field names)
- Invalid YAML syntax (raise yaml.YAMLError with line number)
- Invalid enum values for trigger type or variable source (raise ValueError)
- Empty triggers or steps arrays (raise ValueError)
- Missing command file (raise FileNotFoundError with clear message)

## Performance Targets

- YAML parsing: <10ms per config file
- Schema validation: <1ms per object
