# TASK-0001.1.3.3: Add Dual Output Formatting

**Parent Story**: [STORY-0001.1.3](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3
**Actual Hours**: -

## Objective

Implement comprehensive dual output formatting (rich for humans, JSON for Claude) with structured error responses and consistent formatting across all commands.

## Implementation Checklist

### Phase 1: Enhance OutputFormatter (TDD - Write Tests First)

**Note:** OutputFormatter currently only has `render_rich()` and `render_json()`. This task adds 7 NEW methods.

- [ ] Write tests for `success(message, data=None)` method in both rich and JSON formats
  - Rich: Assert output contains "[green]âœ“[/green]" and message
  - JSON: Assert output is valid JSON with {"status": "success", "message": ..., "data": ...}
- [ ] Write tests for `error(message, details=None, exit_code=1)` method in both formats
  - Rich: Assert output contains "[red]âœ—[/red]" and message
  - JSON: Assert output is valid JSON with {"status": "error", ...}
  - Assert: sys.exit() called with correct exit_code
- [ ] Write tests for `info(message)`, `warning(message)`, `debug(message)` methods
  - Rich: Assert correct icon ([blue]â„¹[/blue], [yellow]âš [/yellow], [dim]Debug:[/dim])
  - JSON: Assert {"level": "info|warning|debug", "message": ...}
- [ ] Write tests for `progress(description, total)` context manager (rich only)
  - Rich: Assert description printed on entry
  - JSON: Assert no output (silent)
- [ ] Write tests for `table(headers, rows)` method (rich table, JSON array)
  - Rich: Assert rich.table.Table rendered
  - JSON: Assert {"type": "table", "headers": [...], "rows": [...]}
- [ ] Run tests: `pytest tests/unit/cli/test_output.py -v` - all fail âœ“

### Phase 2: Implementation (GREEN)

**Add 7 NEW methods to OutputFormatter class in `src/gitstory/cli/output.py`:**

- [ ] Implement `success(message: str, data: dict | None = None) -> None` method
  - Print directly to stdout (rich) or stdout (JSON)
  - Rich: `console.print(f"[green]âœ“[/green] {message}")`
  - JSON: `print(json.dumps({"status": "success", "message": message, "data": data}))`
- [ ] Implement `error(message: str, details: dict | None = None, exit_code: int = 1) -> None` method
  - Print error and call `sys.exit(exit_code)`
  - Rich: `console.print(f"[red]âœ—[/red] {message}", style="bold red")`
  - JSON: `print(json.dumps({"status": "error", "message": message, "details": details, "exit_code": exit_code}))`
- [ ] Implement `info(message: str) -> None`, `warning(message: str) -> None`, `debug(message: str) -> None` methods
  - Print directly to stdout
  - Rich: Uses icons ([blue]â„¹[/blue], [yellow]âš [/yellow], [dim]Debug:[/dim])
  - JSON: `print(json.dumps({"level": "info|warning|debug", "message": message}))`
- [ ] Implement `progress(description: str, total: int)` context manager
  - Returns: contextlib.nullcontext() (no-op placeholder)
  - Rich mode: print description on __enter__, yield self
  - JSON mode: silent (no output), yield self
  - Note: Actual rich.Progress implementation deferred to future task
- [ ] Implement `table(headers: list[str], rows: list[list[str]]) -> None` method
  - Print directly to stdout
  - Rich: Create and print `rich.table.Table` with headers and rows
  - JSON: `print(json.dumps({"type": "table", "headers": headers, "rows": rows}))`
- [ ] Run tests: `pytest tests/unit/cli/test_output.py -v` - all pass âœ“

### Phase 3: Integrate with Commands

- [ ] Update plan.py to use OutputFormatter methods
  - Import: `from gitstory.cli.output import OutputFormatter`
  - Get json_mode from context: `json_mode = ctx.obj.get("json_mode", False)`
  - Create formatter: `output = OutputFormatter(json_mode=json_mode)`
  - Replace: `console.print(f"[blue]â„¹[/blue] Planning {ticket_id}...")` â†’ `output.info(f"Planning {ticket_id}...")`
  - Replace: `console.print("[yellow]âš [/yellow] Coming in EPIC-0001.2...")` â†’ `output.warning("Coming in EPIC-0001.2: Workflow engine & planning logic")`
- [ ] Update review.py to use OutputFormatter methods
  - Same pattern as plan.py (import, get json_mode, create formatter, replace console.print)
- [ ] Update execute.py to use OutputFormatter methods
  - Same pattern as plan.py
- [ ] Update validate.py to use OutputFormatter methods
  - Same pattern as plan.py
- [ ] Update test_plugin.py to use OutputFormatter methods
  - Same pattern as plan.py
- [ ] Update init.py to use OutputFormatter methods
  - Same pattern as plan.py
- [ ] Verify: All commands support --json flag
  - Note: --json is already a global flag defined in cli/__init__.py from TASK-0001.1.3.1
  - Commands access it via ctx.obj["json_mode"]
  - Test: `uv run python -m gitstory --json plan STORY-0001.2.4` outputs valid JSON

### Verification

- [ ] All unit tests pass
- [ ] `gitstory plan STORY-0001.2.4` shows rich colored output
- [ ] `gitstory --json plan STORY-0001.2.4` outputs valid JSON
- [ ] Error messages include exit codes and structured details
- [ ] Tables render correctly in both modes
- [ ] Progress indicators work in rich mode, silent in JSON mode
- [ ] JSON output parseable by `jq` and `python -m json.tool`
- [ ] Code coverage >90%

## Files to Create/Modify

- MODIFY: `src/gitstory/cli/output.py` (~200 lines total, add 120 lines of methods)
- MODIFY: `src/gitstory/cli/plan.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/review.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/execute.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/validate.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/test_plugin.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/init.py` (use OutputFormatter methods)
- MODIFY: `tests/unit/cli/test_output.py` (~200 lines total, add 140 lines of tests)

## OutputFormatter API Design

### Rich Mode (Default)

```python
# Success message with green checkmark
output.success("Story created successfully", data={"ticket_id": "STORY-0001.2.4"})
# [green]âœ“[/green] Story created successfully
# Ticket ID: STORY-0001.2.4

# Error message with red X
output.error("Invalid ticket ID format", details={"provided": "INVALID"}, exit_code=1)
# [red]âœ—[/red] Invalid ticket ID format
# Provided: INVALID
# (exits with code 1)

# Info/Warning/Debug
output.info("Processing ticket...")        # [blue]â„¹[/blue] Processing ticket...
output.warning("Coming in EPIC-0001.2...")  # [yellow]âš [/yellow] Coming in EPIC-0001.2...
output.debug("Checking file paths...")     # [dim]Debug: Checking file paths...[/dim]

# Progress indicator (simplified for placeholder - no actual progress tracking yet)
with output.progress("Planning epic", total=5) as progress:
    # In placeholder: progress is a no-op object
    # Future: will return rich.Progress instance
    pass
# Shows rich progress bar (placeholder just shows message)

# Table
output.table(
    headers=["ID", "Title", "Status"],
    rows=[
        ["STORY-0001.2.4", "Vector Storage", "ðŸ”µ Not Started"],
        ["STORY-0001.2.5", "Query Engine", "ðŸŸ¡ In Progress"],
    ]
)
# Renders rich.table.Table
```

### JSON Mode (--json flag)

```python
# Success message
output.success("Story created successfully", data={"ticket_id": "STORY-0001.2.4"})
# {
#   "status": "success",
#   "message": "Story created successfully",
#   "data": {"ticket_id": "STORY-0001.2.4"}
# }

# Error message
output.error("Invalid ticket ID format", details={"provided": "INVALID"}, exit_code=1)
# {
#   "status": "error",
#   "message": "Invalid ticket ID format",
#   "details": {"provided": "INVALID"},
#   "exit_code": 1
# }
# (exits with code 1)

# Info/Warning/Debug
output.info("Processing ticket...")
# {"level": "info", "message": "Processing ticket..."}

output.warning("Coming in EPIC-0001.2...")
# {"level": "warning", "message": "Coming in EPIC-0001.2..."}

# Progress (no-op in JSON mode - placeholder implementation)
with output.progress("Planning epic", total=5) as progress:
    # In placeholder: context manager is no-op
    pass
# (silent, no output in JSON mode)

# Table
output.table(
    headers=["ID", "Title", "Status"],
    rows=[
        ["STORY-0001.2.4", "Vector Storage", "ðŸ”µ Not Started"],
        ["STORY-0001.2.5", "Query Engine", "ðŸŸ¡ In Progress"],
    ]
)
# {
#   "type": "table",
#   "headers": ["ID", "Title", "Status"],
#   "rows": [
#     ["STORY-0001.2.4", "Vector Storage", "ðŸ”µ Not Started"],
#     ["STORY-0001.2.5", "Query Engine", "ðŸŸ¡ In Progress"]
#   ]
# }
```

## Implementation Strategy

### OutputFormatter Class Structure

```python
class OutputFormatter:
    """Dual-mode output formatter for GitStory CLI."""

    def __init__(self, json_mode: bool = False):
        self.json_mode = json_mode
        self.console = Console() if not json_mode else None

    def success(self, message: str, data: dict = None) -> None:
        """Output success message."""
        if self.json_mode:
            print(json.dumps({"status": "success", "message": message, "data": data}))
        else:
            self.console.print(f"[green]âœ“[/green] {message}")
            if data:
                for key, value in data.items():
                    self.console.print(f"  {key}: {value}")

    def error(self, message: str, details: dict = None, exit_code: int = 1) -> None:
        """Output error message and exit."""
        if self.json_mode:
            print(json.dumps({
                "status": "error",
                "message": message,
                "details": details,
                "exit_code": exit_code
            }))
        else:
            self.console.print(f"[red]âœ—[/red] {message}", style="bold red")
            if details:
                self.console.print(f"Details: {details}")
        sys.exit(exit_code)

    # ... other methods
```

## Structured Error Responses

### Error Categories
1. **User Input Errors** (exit code 1): Invalid ticket ID, missing file
2. **Validation Errors** (exit code 2): YAML syntax error, schema violation
3. **Runtime Errors** (exit code 3): Git operation failed, file permission denied
4. **Plugin Errors** (exit code 4): Plugin execution failed, timeout

### Error Response Format

**Note:** For placeholder implementation, use simple format matching `error()` method signature.
Future enhancements (EPIC-0001.2) will add error_category and suggestions fields.

```json
{
  "status": "error",
  "message": "Invalid ticket ID format",
  "details": {
    "provided": "INVALID",
    "expected_pattern": "STORY-NNNN.E.S"
  },
  "exit_code": 1
}
```

**Future Enhancement (not in this task):**
```json
{
  "status": "error",
  "error_category": "user_input",
  "message": "Invalid ticket ID format",
  "details": {...},
  "exit_code": 1,
  "suggestions": ["Check ticket ID format: STORY-0001.2.4"]
}
```

## Pattern Reuse

- `rich.console.Console` - Terminal rendering (already dependency)
- `rich.progress` - Progress bars
- `rich.table` - Table formatting
- `json.dumps(indent=2)` - JSON formatting

## Dependencies

- TASK-0001.1.3.1 complete âœ… (OutputFormatter class exists at src/gitstory/cli/output.py)
- TASK-0001.1.3.2 complete âœ… (6 commands exist: plan, review, execute, validate, test_plugin, init)
- Global --json flag already implemented in cli/__init__.py (ctx.obj["json_mode"])

## Success Criteria

- âœ… OutputFormatter supports all message types (success, error, info, warning, debug)
- âœ… Rich mode renders with colors, icons, and formatting
- âœ… JSON mode outputs valid, parseable JSON
- âœ… Error responses include exit codes and structured details
- âœ… Tables render correctly in both modes
- âœ… Progress indicators work in rich mode, silent in JSON
- âœ… All commands use OutputFormatter consistently
- âœ… Code coverage >90%
