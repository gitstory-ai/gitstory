# TASK-0001.1.3.3: Add Dual Output Formatting

**Parent Story**: [STORY-0001.1.3](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 3
**Actual Hours**: -

## Objective

Implement comprehensive dual output formatting (rich for humans, JSON for Claude) with structured error responses and consistent formatting across all commands.

## Implementation Checklist

### Phase 1: Enhance OutputFormatter (TDD - Write Tests First)

- [ ] Write tests for success messages in both rich and JSON formats
- [ ] Write tests for error messages in both formats
- [ ] Write tests for info/warning/debug levels
- [ ] Write tests for progress indicators (rich only)
- [ ] Write tests for table formatting (rich with JSON fallback)
- [ ] Run tests - all fail âœ“

### Phase 2: Implementation (GREEN)

- [ ] Extend `src/gitstory/cli/output.py` OutputFormatter class
- [ ] Implement `success(message, data=None)` method
- [ ] Implement `error(message, details=None, exit_code=1)` method
- [ ] Implement `info(message)`, `warning(message)`, `debug(message)` methods
- [ ] Implement `progress(description, total)` context manager (rich only, no-op in JSON)
- [ ] Implement `table(headers, rows)` method (rich table, JSON array)
- [ ] Run tests - all pass âœ“

### Phase 3: Integrate with Commands

- [ ] Update plan.py to use OutputFormatter methods
- [ ] Update review.py to use OutputFormatter methods
- [ ] Update execute.py to use OutputFormatter methods
- [ ] Update validate.py to use OutputFormatter methods
- [ ] Update test_plugin.py to use OutputFormatter methods
- [ ] Update init.py to use OutputFormatter methods
- [ ] Verify: All commands support --json flag

### Verification

- [ ] All unit tests pass
- [ ] `gitstory plan STORY-0001.2.4` shows rich colored output
- [ ] `gitstory --json plan STORY-0001.2.4` outputs valid JSON
- [ ] Error messages include exit codes and structured details
- [ ] Tables render correctly in both modes
- [ ] Progress indicators work in rich mode, silent in JSON mode
- [ ] JSON output parseable by `jq` and `python -m json.tool`
- [ ] Code coverage >90%

## Files to Create/Modify

- MODIFY: `src/gitstory/cli/output.py` (~200 lines total, add 120 lines of methods)
- MODIFY: `src/gitstory/cli/plan.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/review.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/execute.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/validate.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/test_plugin.py` (use OutputFormatter methods)
- MODIFY: `src/gitstory/cli/init.py` (use OutputFormatter methods)
- MODIFY: `tests/unit/cli/test_output.py` (~200 lines total, add 140 lines of tests)

## OutputFormatter API Design

### Rich Mode (Default)

```python
# Success message with green checkmark
output.success("Story created successfully", data={"ticket_id": "STORY-0001.2.4"})
# [green]âœ“[/green] Story created successfully
# Ticket ID: STORY-0001.2.4

# Error message with red X
output.error("Invalid ticket ID format", details={"provided": "INVALID"}, exit_code=1)
# [red]âœ—[/red] Invalid ticket ID format
# Provided: INVALID
# (exits with code 1)

# Info/Warning/Debug
output.info("Processing ticket...")        # [blue]â„¹[/blue] Processing ticket...
output.warning("Coming in EPIC-0001.2...")  # [yellow]âš [/yellow] Coming in EPIC-0001.2...
output.debug("Checking file paths...")     # [dim]Debug: Checking file paths...[/dim]

# Progress indicator
with output.progress("Planning epic", total=5) as progress:
    progress.update(task_id, advance=1)
# Shows rich progress bar

# Table
output.table(
    headers=["ID", "Title", "Status"],
    rows=[
        ["STORY-0001.2.4", "Vector Storage", "ðŸ”µ Not Started"],
        ["STORY-0001.2.5", "Query Engine", "ðŸŸ¡ In Progress"],
    ]
)
# Renders rich.table.Table
```

### JSON Mode (--json flag)

```python
# Success message
output.success("Story created successfully", data={"ticket_id": "STORY-0001.2.4"})
# {
#   "status": "success",
#   "message": "Story created successfully",
#   "data": {"ticket_id": "STORY-0001.2.4"}
# }

# Error message
output.error("Invalid ticket ID format", details={"provided": "INVALID"}, exit_code=1)
# {
#   "status": "error",
#   "message": "Invalid ticket ID format",
#   "details": {"provided": "INVALID"},
#   "exit_code": 1
# }
# (exits with code 1)

# Info/Warning/Debug
output.info("Processing ticket...")
# {"level": "info", "message": "Processing ticket..."}

output.warning("Coming in EPIC-0001.2...")
# {"level": "warning", "message": "Coming in EPIC-0001.2..."}

# Progress (no-op in JSON mode)
with output.progress("Planning epic", total=5) as progress:
    progress.update(task_id, advance=1)
# (silent, no output until completion)

# Table
output.table(
    headers=["ID", "Title", "Status"],
    rows=[
        ["STORY-0001.2.4", "Vector Storage", "ðŸ”µ Not Started"],
        ["STORY-0001.2.5", "Query Engine", "ðŸŸ¡ In Progress"],
    ]
)
# {
#   "type": "table",
#   "headers": ["ID", "Title", "Status"],
#   "rows": [
#     ["STORY-0001.2.4", "Vector Storage", "ðŸ”µ Not Started"],
#     ["STORY-0001.2.5", "Query Engine", "ðŸŸ¡ In Progress"]
#   ]
# }
```

## Implementation Strategy

### OutputFormatter Class Structure

```python
class OutputFormatter:
    """Dual-mode output formatter for GitStory CLI."""

    def __init__(self, json_mode: bool = False):
        self.json_mode = json_mode
        self.console = Console() if not json_mode else None

    def success(self, message: str, data: dict = None) -> None:
        """Output success message."""
        if self.json_mode:
            print(json.dumps({"status": "success", "message": message, "data": data}))
        else:
            self.console.print(f"[green]âœ“[/green] {message}")
            if data:
                for key, value in data.items():
                    self.console.print(f"  {key}: {value}")

    def error(self, message: str, details: dict = None, exit_code: int = 1) -> None:
        """Output error message and exit."""
        if self.json_mode:
            print(json.dumps({
                "status": "error",
                "message": message,
                "details": details,
                "exit_code": exit_code
            }))
        else:
            self.console.print(f"[red]âœ—[/red] {message}", style="bold red")
            if details:
                self.console.print(f"Details: {details}")
        sys.exit(exit_code)

    # ... other methods
```

## Structured Error Responses

### Error Categories
1. **User Input Errors** (exit code 1): Invalid ticket ID, missing file
2. **Validation Errors** (exit code 2): YAML syntax error, schema violation
3. **Runtime Errors** (exit code 3): Git operation failed, file permission denied
4. **Plugin Errors** (exit code 4): Plugin execution failed, timeout

### Error Response Format
```json
{
  "status": "error",
  "error_category": "user_input",
  "message": "Invalid ticket ID format",
  "details": {
    "provided": "INVALID",
    "expected_pattern": "STORY-NNNN.E.S"
  },
  "exit_code": 1,
  "suggestions": [
    "Check ticket ID format: STORY-0001.2.4",
    "Run: gitstory validate ticket STORY-0001.2.4"
  ]
}
```

## Pattern Reuse

- `rich.console.Console` - Terminal rendering (already dependency)
- `rich.progress` - Progress bars
- `rich.table` - Table formatting
- `json.dumps(indent=2)` - JSON formatting

## Dependencies

- TASK-0001.1.3.1 complete (OutputFormatter class exists)
- TASK-0001.1.3.2 complete (commands to integrate with)

## Success Criteria

- âœ… OutputFormatter supports all message types (success, error, info, warning, debug)
- âœ… Rich mode renders with colors, icons, and formatting
- âœ… JSON mode outputs valid, parseable JSON
- âœ… Error responses include exit codes and structured details
- âœ… Tables render correctly in both modes
- âœ… Progress indicators work in rich mode, silent in JSON
- âœ… All commands use OutputFormatter consistently
- âœ… Code coverage >90%
