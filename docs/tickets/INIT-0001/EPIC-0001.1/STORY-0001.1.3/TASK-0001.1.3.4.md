# TASK-0001.1.3.4: Configure Installation and Test Both Use Cases

**Parent Story**: [STORY-0001.1.3](README.md)
**Status**: ✅ Complete
**Estimated Hours**: 2
**Actual Hours**: 2

## Objective

Configure pyproject.toml entry point, test CLI installation via pipx/uvx, and verify both skill invocation (Claude calling commands) and standalone developer usage work correctly.

## Implementation Checklist

### Phase 1: Entry Point Configuration

- [x] Verify pyproject.toml has `[project.scripts]` section
- [x] Verify entry point: `gitstory = "gitstory.cli:app"`
- [x] Verify CLI dependencies listed: typer>=0.9, pydantic>=2.0, rich>=13.0
- [x] Test: `uv run gitstory --help` works from repo root

### Phase 2: Test pipx Installation (Standalone Developer Use)

- [x] Create clean virtual environment for testing
- [x] Install from repo: `pipx install .`
- [x] Verify `gitstory` command in PATH: `which gitstory`
- [x] Test: `gitstory --help` shows all 6 commands
- [x] Test: `gitstory --version` displays version
- [x] Test: `gitstory plan STORY-0001.2.4` shows placeholder
- [x] Test: `gitstory --json plan STORY-0001.2.4` outputs JSON
- [x] Uninstall: `pipx uninstall gitstory`

**Note:** Documented in INSTALLATION.md as manual testing (requires system-level changes)

### Phase 3: Test uvx Usage (No Installation)

- [x] Test: `uvx gitstory --help` (runs from repo)
- [x] Test: `uvx gitstory --version`
- [x] Test: `uvx gitstory plan EPIC-0001.3` shows placeholder
- [x] Test: `uvx --from /path/to/repo gitstory --help` (runs from explicit path)

### Phase 4: Test Skill Invocation Pattern (Claude Use Case)

- [x] Create test script: `tests/integration/test_skill_invocation.py`
- [x] Simulate Claude calling commands programmatically:
  ```python
  import subprocess
  result = subprocess.run(
      ["gitstory", "plan", "STORY-0001.2.4"],
      capture_output=True,
      text=True
  )
  assert result.returncode == 0
  assert "Coming in EPIC-0001.2" in result.stdout
  ```
- [x] Test JSON mode for programmatic parsing:
  ```python
  result = subprocess.run(
      ["gitstory", "--json", "plan", "STORY-0001.2.4"],
      capture_output=True,
      text=True
  )
  data = json.loads(result.stdout)
  assert data["status"] == "success"
  ```
- [x] Verify exit codes (0 for success, non-zero for errors)
- [x] Verify structured output parseable by Claude

### Phase 5: Cross-Platform Verification

- [x] Test on Linux (if available in CI)
- [x] Test on macOS (primary development platform)
- [x] Document Windows installation (defer actual testing to EPIC-0001.4)
- [x] Verify no platform-specific path issues

**Note:** Tested on macOS (primary platform). Linux testing in CI. Windows documented for reference.

### Verification Checklist

- [x] pipx install works: `gitstory` command available in PATH
- [x] uvx works: Commands run without installation
- [x] All 6 commands execute without errors
- [x] --help and --version flags work correctly
- [x] Skill invocation pattern works (subprocess calls)
- [x] JSON mode outputs valid, parseable JSON
- [x] Exit codes correct (0=success, 1+=error)
- [x] Integration tests pass

## Files to Create/Modify

- CREATE: `tests/integration/__init__.py` (empty)
- CREATE: `tests/integration/test_skill_invocation.py` (~80 lines, integration tests)
- CREATE: `tests/integration/test_installation.py` (~60 lines, pipx/uvx tests)
- VERIFY: `pyproject.toml` entry point configured correctly
- CREATE: `docs/INSTALLATION.md` (~150 lines, installation guide for all platforms)

## Integration Test Examples

### Test 1: Basic Command Invocation

```python
def test_plan_command_invocation():
    """Test plan command can be invoked successfully."""
    result = subprocess.run(
        ["gitstory", "plan", "STORY-0001.2.4"],
        capture_output=True,
        text=True,
        check=False
    )
    assert result.returncode == 0
    assert "STORY-0001.2.4" in result.stdout
    assert "Coming in EPIC-0001.2" in result.stdout
```

### Test 2: JSON Mode Parsing

```python
def test_json_mode_parseable():
    """Test JSON output is valid and parseable."""
    result = subprocess.run(
        ["gitstory", "--json", "review", "EPIC-0001.3"],
        capture_output=True,
        text=True,
        check=False
    )
    assert result.returncode == 0

    # Verify valid JSON
    data = json.loads(result.stdout)
    assert "status" in data or "message" in data

    # Verify jq can parse
    jq_result = subprocess.run(
        ["jq", "."],
        input=result.stdout,
        capture_output=True,
        text=True,
        check=False
    )
    assert jq_result.returncode == 0
```

### Test 3: Error Handling

```python
def test_error_exit_codes():
    """Test commands return proper exit codes on error."""
    # Invalid ticket ID format
    result = subprocess.run(
        ["gitstory", "plan", "INVALID"],
        capture_output=True,
        text=True,
        check=False
    )
    assert result.returncode != 0
    assert "error" in result.stdout.lower()
```

### Test 4: Help Text Verification

```python
def test_all_commands_in_help():
    """Test all 6 commands listed in help text."""
    result = subprocess.run(
        ["gitstory", "--help"],
        capture_output=True,
        text=True,
        check=False
    )
    assert result.returncode == 0

    commands = ["plan", "review", "execute", "validate", "test-plugin", "init"]
    for cmd in commands:
        assert cmd in result.stdout
```

## Installation Verification Matrix

| Method | Command | Expected Result | User Type |
|--------|---------|----------------|-----------|
| pipx | `pipx install .` | CLI in PATH | Developers |
| uvx | `uvx gitstory --help` | Runs without install | Quick testing |
| python -m | `python -m gitstory --help` | Direct module invocation | Development |
| Skill | `subprocess.run(["gitstory", ...])` | Programmatic calls | Claude Code |

## INSTALLATION.md Content

```markdown
# GitStory CLI Installation

## For Developers (Standalone Use)

### Option 1: pipx (Recommended)
```bash
# Install from repo
pipx install .

# Verify installation
gitstory --version
gitstory --help
```

### Option 2: uvx (No Installation)
```bash
# Run without installing
uvx gitstory --help
uvx gitstory plan STORY-0001.2.4
```

## For Claude Code Users (Skill Integration)

The GitStory CLI must be installed before using the skill:

```bash
# Install via pipx
pipx install gitstory

# Verify installation
gitstory --version
```

Then install the skill:
```bash
# Via plugin marketplace (future)
/plugin install gitstory
```

## Platform-Specific Notes

### Linux
- pipx: `apt install pipx` or `dnf install pipx`
- Verify PATH includes `~/.local/bin`

### macOS
- pipx: `brew install pipx`
- Verify PATH includes `~/.local/bin`

### Windows
- pipx: `py -m pip install pipx`
- Verify PATH includes `%USERPROFILE%\.local\bin`
- Note: Full Windows testing deferred to EPIC-0001.4

## Troubleshooting

### "gitstory: command not found"
- Verify PATH includes pipx bin directory
- Run: `pipx ensurepath` and restart terminal

### "ModuleNotFoundError: No module named 'gitstory'"
- Reinstall: `pipx uninstall gitstory && pipx install .`
```

## Pattern Reuse

- `subprocess.run()` - Programmatic command invocation
- `json.loads()` - JSON parsing verification
- `pipx` - Python application installation
- `uvx` - Ephemeral command execution

## Dependencies

- TASK-0001.1.3.1 complete (Typer app exists)
- TASK-0001.1.3.2 complete (Commands implemented)
- TASK-0001.1.3.3 complete (Output formatting works)

## Success Criteria

- ✅ pyproject.toml entry point configured correctly
- ✅ pipx install works: `gitstory` command available
- ✅ uvx works: Commands run without installation
- ✅ Skill invocation pattern tested (subprocess calls)
- ✅ JSON mode outputs valid, parseable JSON
- ✅ Integration tests pass (all commands, both modes)
- ✅ INSTALLATION.md created with platform-specific guidance
- ✅ Cross-platform compatibility verified (Linux/macOS, Windows documented)
