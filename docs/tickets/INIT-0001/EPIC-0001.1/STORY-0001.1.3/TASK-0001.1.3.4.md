# TASK-0001.1.3.4: Implement template lookup priority system

**Parent Story**: [STORY-0001.1.3](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 5
**Actual Hours**: -

## Objective

Implement 3-level template lookup priority system (project â†’ user â†’ skill) with fallback handling. Integration task that completes final BDD scenario and verifies all acceptance criteria.

## BDD Progress

**Before this task**: 5/6 scenarios passing
**After this task**: 6/6 scenarios passing âœ…

**Scenarios for this task:**

- Scenario 4: Template lookup priority is: project â†’ user â†’ skill (FULL - priority cascade implementation)

## Implementation Checklist

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/templates/test_template_lookup.py`
- [ ] Write test for find_template() with project override (2+ tests)
  - [ ] Test .gitstory/templates/story.md found first
  - [ ] Test project override takes precedence over user/skill
- [ ] Write test for find_template() with user override (2+ tests)
  - [ ] Test ~/.claude/skills/gitstory/templates/story.md found when no project
  - [ ] Test user override takes precedence over skill default
- [ ] Write test for find_template() with skill default (2+ tests)
  - [ ] Test skills/gitstory/templates/story.md used as fallback
  - [ ] Test skill default when no project/user overrides
- [ ] Write test for find_template() with missing template (2+ tests)
  - [ ] Test raises FileNotFoundError with clear message
  - [ ] Test fallback to generic.md if available
- [ ] Write test for template path resolution with {baseDir} variable (2+ tests)
- [ ] Run tests - all fail âœ“

### Implementation (GREEN)

- [ ] Create `src/gitstory/templates/template_loader.py`
- [ ] Implement find_template() function:
  ```python
  from pathlib import Path
  from typing import Optional

  def find_template(template_name: str, base_dir: Optional[Path] = None) -> Path:
      """Load template with priority: project â†’ user â†’ skill.

      Args:
          template_name: Template name (e.g., "story", "task")
          base_dir: Base directory for skill default ({baseDir} replacement)

      Returns:
          Path to first matching template file

      Raises:
          FileNotFoundError: If template not found at any priority level
      """
      template_file = f"{template_name}.md"

      # Level 1: Project override (.gitstory/templates/)
      project_template = Path.cwd() / ".gitstory" / "templates" / template_file
      if project_template.exists():
          return project_template

      # Level 2: User override (~/.claude/skills/gitstory/templates/)
      user_template = Path.home() / ".claude" / "skills" / "gitstory" / "templates" / template_file
      if user_template.exists():
          return user_template

      # Level 3: Skill default (skills/gitstory/templates/)
      if base_dir is None:
          base_dir = Path(__file__).parent.parent.parent / "skills" / "gitstory"
      skill_template = base_dir / "templates" / template_file
      if skill_template.exists():
          return skill_template

      # Fallback: Try generic.md
      generic_template = base_dir / "templates" / "generic.md"
      if generic_template.exists():
          return generic_template

      raise FileNotFoundError(
          f"Template '{template_name}' not found in:\n"
          f"  1. {project_template} (project)\n"
          f"  2. {user_template} (user)\n"
          f"  3. {skill_template} (skill)"
      )
  ```
- [ ] Implement load_template() wrapper function:
  ```python
  def load_template(template_name: str) -> dict:
      """Load and parse template with YAML frontmatter.

      Returns:
          dict with 'frontmatter' and 'body' keys
      """
      template_path = find_template(template_name)
      content = template_path.read_text(encoding='utf-8')

      from .yaml_parser import parse_frontmatter
      frontmatter = parse_frontmatter(content)

      # Extract body (after second --- delimiter)
      if content.startswith('---'):
          parts = content.split('---', 2)
          body = parts[2].strip() if len(parts) > 2 else ""
      else:
          body = content

      return {
          'frontmatter': frontmatter,
          'body': body,
          'path': str(template_path)
      }
  ```
- [ ] Add support for {baseDir} variable resolution
- [ ] Add logging for template lookup path traversal
- [ ] Run tests - all pass âœ“

### BDD Implementation (Scenario 4)

- [ ] Implement step: "Given .gitstory/templates/custom-story.md (project override)"
- [ ] Implement step: "And ~/.claude/skills/gitstory/templates/story.md (user override)"
- [ ] Implement step: "And {baseDir}/templates/story.md (skill default)"
- [ ] Implement step: "When loading a story template"
- [ ] Implement step: "Then project override (.gitstory/custom-story.md) is checked first"
- [ ] Implement step: "And user override (~/.claude/gitstory/templates/) is checked second"
- [ ] Implement step: "And skill default ({baseDir}/templates/) is used as fallback"
- [ ] Implement step: "And system loads first match found in priority order"
- [ ] Run BDD tests - ALL 6 scenarios pass âœ…

### Integration Verification

- [ ] Create example project override: `.gitstory/templates/story-custom.md`
- [ ] Test priority cascade with real filesystem paths
- [ ] Test with symlinks (user â†’ project, project â†’ skill)
- [ ] Test with missing directories (graceful degradation)
- [ ] Test with permission errors (clear error messages)
- [ ] **Template syntax validation**: Verify all templates parse correctly with Python's string.Template
  - [ ] Test that all templates use ${variable} syntax (not {variable} or $variable)
  - [ ] Test template.safe_substitute() with mock context dict
  - [ ] Verify missing variables render as literal ${unknown_var} (safe_substitute behavior)
  - [ ] Test edge cases: falsy values (None â†’ '', False â†’ '', 0 â†’ '0'), special chars in variable names
  - [ ] Document string.Template syntax in template authoring guide
- [ ] Verify all 8 acceptance criteria can be checked:
  - [ ] Template directory structure created âœ“
  - [ ] 6 templates implemented âœ“
  - [ ] YAML frontmatter with required fields âœ“
  - [ ] Markdown body scaffolds âœ“
  - [ ] Field validation documented âœ“
  - [ ] Template lookup priority documented âœ“
  - [ ] Templates render correctly âœ“
  - [ ] YAML parser validation âœ“

### Documentation

- [ ] Add docstrings to all functions with examples
- [ ] Document lookup priority in module-level docstring
- [ ] Add example usage to README:
  ```python
  from gitstory.templates import find_template, load_template

  # Find template path (returns Path object)
  template_path = find_template("story")

  # Load and parse template (returns dict with frontmatter + body)
  template = load_template("story")
  print(template['frontmatter']['fields'])
  print(template['body'])
  ```
- [ ] Document {baseDir} variable usage in configuration
- [ ] Add troubleshooting guide for template not found errors

### Verification

- [ ] All unit tests pass (10+ tests, 100% coverage for template_loader.py)
- [ ] All BDD scenarios pass (6/6 passing âœ…)
- [ ] Template lookup follows documented priority order
- [ ] Error messages are clear and actionable
- [ ] All acceptance criteria verified and documented
- [ ] Story progress updated to 100%

## Files to Create/Modify

- CREATE: `src/gitstory/templates/template_loader.py` (~120 lines, lookup + load functions)
- CREATE: `src/gitstory/templates/__init__.py` (~10 lines, exports)
- CREATE: `tests/unit/templates/test_template_lookup.py` (~200 lines, 10+ tests)
- MODIFY: `tests/e2e/steps/test_templates.py` (implement steps for Scenario 4)
- MODIFY: `docs/tickets/INIT-0001/EPIC-0001.1/STORY-0001.1.3/README.md` (update progress to 100%)

## Pattern Reuse

- `Priority cascade file lookup` (Git/NPM pattern) - Check multiple locations in priority order, return first match

## Integration Testing

Test with real filesystem structure:

```bash
# Setup test directories
mkdir -p .gitstory/templates
mkdir -p ~/.claude/skills/gitstory/templates

# Test project override (highest priority)
cp skills/gitstory/templates/story.md .gitstory/templates/story-custom.md
# Verify find_template("story-custom") finds project version

# Test user override (medium priority)
cp skills/gitstory/templates/task.md ~/.claude/skills/gitstory/templates/
# Verify find_template("task") finds user version when no project override

# Test skill default (lowest priority / fallback)
# Verify find_template("epic") finds skill version when no project/user overrides
```

## Edge Cases Handled

- Missing .gitstory/ directory (skip gracefully)
- Missing ~/.claude/ directory (skip gracefully)
- Permission denied on template directory (clear error message)
- Template file is a directory (raise TypeError)
- Circular symlinks (detect and break loop)
- Empty template file (return empty frontmatter + body)

## Success Criteria

- [ ] All 6 BDD scenarios passing âœ…
- [ ] All unit tests passing (10+ tests)
- [ ] Template lookup documented with examples
- [ ] Error messages are actionable
- [ ] All acceptance criteria verified
- [ ] Story marked 100% complete
