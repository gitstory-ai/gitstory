# TASK-0001.1.5.2: Implement config lookup priority system

**Parent Story**: [STORY-0001.1.5](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 8
**Actual Hours**: -

## Objective

Implement Python code for command config lookup (priority: project â†’ user â†’ skill) and config version validation. This provides the infrastructure for customizable command behavior in future epics.

## Implementation Checklist

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/commands/test_config_loader.py`
- [ ] Write test: `test_load_command_config_project_override(tmp_path)`
  - Mock project config at `.gitstory/commands/plan.yaml`
  - Assert loads project config (highest priority)
- [ ] Write test: `test_load_command_config_user_override(tmp_path)`
  - Mock user config at `~/.claude/skills/gitstory/commands/plan.yaml`
  - No project config exists
  - Assert loads user config
- [ ] Write test: `test_load_command_config_skill_default(tmp_path)`
  - No project or user configs exist
  - Mock skill config at `{baseDir}/commands/plan.yaml`
  - Assert loads skill config (lowest priority)
- [ ] Write test: `test_load_command_config_not_found()`
  - Config doesn't exist at any level
  - Assert raises FileNotFoundError with helpful message
- [ ] Write test: `test_validate_config_version_valid()`
  - Config has config_version: "1.0"
  - Assert validation passes
- [ ] Write test: `test_validate_config_version_missing()`
  - Config missing config_version field
  - Assert raises ValueError
- [ ] Write test: `test_validate_config_version_unsupported()`
  - Config has config_version: "2.0" (future version)
  - Assert raises ValueError with upgrade message
- [ ] Run tests: `uv run pytest tests/unit/commands/test_config_loader.py`
  - All should fail âœ“ (code doesn't exist yet)

### Implementation (GREEN)

- [ ] Create `src/gitstory/commands/config_loader.py`
- [ ] Define constant: `SUPPORTED_CONFIG_VERSION = "1.0"`
- [ ] Implement `load_command_config(command_name: str) -> dict`:
  - Check project override: `.gitstory/commands/{command_name}.yaml`
  - If exists, load and validate version, return
  - Check user override: `~/.claude/skills/gitstory/commands/{command_name}.yaml`
  - If exists, load and validate version, return
  - Check skill default: `{baseDir}/commands/{command_name}.yaml`
  - If exists, load and validate version, return
  - If none exist, raise FileNotFoundError with helpful message

- [ ] Implement `validate_config_version(config: dict, config_path: Path) -> None`:
  - Check if 'config_version' field exists
  - If missing, raise ValueError("Config missing config_version field")
  - If version != SUPPORTED_CONFIG_VERSION, raise ValueError with:
    - Current version found
    - Supported version
    - Suggestion to upgrade/downgrade
  - Return None if valid

- [ ] Implement `parse_command_config(config_path: Path) -> dict`:
  - Read YAML file with yaml.safe_load()
  - Validate config version
  - Return config dict
  - Handle yaml.YAMLError exceptions

- [ ] Run tests: `uv run pytest tests/unit/commands/test_config_loader.py`
  - All should pass âœ“

### Refactor

- [ ] Add type hints to all functions
- [ ] Add docstrings with examples
- [ ] Extract constants (config paths, version)
- [ ] Add error messages with context (which config file, what version expected)
- [ ] Run mypy: `uv run mypy src/gitstory/`
- [ ] Run ruff: `uv run ruff check src/ tests/`

### Integration Validation

- [ ] Verify config lookup priority works end-to-end:
  ```python
  # Manual test script
  from gitstory.commands.config_loader import load_command_config

  # Should load from skills/gitstory/commands/plan.yaml
  config = load_command_config("plan")
  print(f"Loaded from: {config.get('_source_path', 'unknown')}")
  print(f"Config version: {config['config_version']}")
  print(f"Ticket types: {list(config['interview_questions'].keys())}")
  ```

- [ ] Verify version validation works:
  ```python
  from pathlib import Path
  from gitstory.commands.config_loader import validate_config_version
  import yaml

  # Test with valid config
  config_path = Path("skills/gitstory/commands/plan.yaml")
  config = yaml.safe_load(config_path.read_text())
  validate_config_version(config, config_path)  # Should succeed
  print("âœ“ Version validation passed")
  ```

### Final Verification

- [ ] All unit tests pass: `uv run pytest tests/unit/commands/`
- [ ] Type checking passes: `uv run mypy src/gitstory/`
- [ ] Linting passes: `uv run ruff check src/ tests/`
- [ ] Code coverage >80%: `uv run pytest --cov=src/gitstory --cov-report=term-missing`
- [ ] Both plan.yaml and review.yaml load successfully with version validation

## Files to Create/Modify

- **CREATE**: `src/gitstory/commands/config_loader.py` (~100 lines, priority lookup + version validation)
- **CREATE**: `tests/unit/commands/test_config_loader.py` (~180 lines, 7+ tests)
- **CREATE**: `src/gitstory/commands/__init__.py` (empty, package marker)
- **CREATE**: `tests/unit/commands/__init__.py` (empty, package marker)

## Pattern Reuse

- Template lookup pattern from `src/gitstory/templates/template_loader.py` (TASK-0001.1.4.2)
- YAML validation pattern from `src/gitstory/validators/yaml_validator.py` (STORY-0001.1.1)
- TDD workflow: Red â†’ Green â†’ Refactor
- Priority lookup: project â†’ user â†’ skill (same as template system)

## Dependencies

- TASK-0001.1.5.1 complete: plan.yaml and review.yaml created and valid
- TASK-0001.1.4.2 complete: Template loader pattern to reference
- Python 3.12+ with PyYAML, pytest, mypy, ruff

## Notes

**Testing strategy**: Per TESTING.md, Python code gets unit tests. This task implements TDD with comprehensive coverage for:
- Priority lookup logic (3 levels)
- Config version validation
- Error handling (missing files, invalid versions)

**Config versioning**: The config_version field enables:
- Future format evolution (v1.0 â†’ v1.1 â†’ v2.0)
- Clear error messages when config format changes
- Migration path for users (detect old config, suggest upgrade)

**Reusability**: This config loader will be used by:
- `/gitstory:plan` command (loads plan.yaml)
- `/gitstory:review` command (loads review.yaml)
- Future commands that need configuration

**Coverage goal**: >80% for all Python code per TESTING.md. Config loader should have comprehensive test coverage including edge cases.
