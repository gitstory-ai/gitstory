# TASK-0001.1.4.2: Implement template lookup priority and validation

**Parent Story**: [STORY-0001.1.4](README.md)
**Status**: ðŸ”µ Not Started
**Estimated Hours**: 8
**Actual Hours**: -

## Objective

Implement Python code for template lookup (priority: project â†’ user â†’ skill) and YAML frontmatter validation. This provides the infrastructure for template-based ticket creation in future epics.

## Implementation Checklist

### Unit Tests First (TDD - RED)

- [ ] Create `tests/unit/validators/test_template_validator.py`
- [ ] Write test: `test_validate_template_frontmatter_valid()`
  - Test with valid YAML frontmatter (name, description, fields)
  - Assert returns True
- [ ] Write test: `test_validate_template_frontmatter_no_frontmatter()`
  - Test with file not starting with `---`
  - Assert returns False
- [ ] Write test: `test_validate_template_frontmatter_invalid_yaml()`
  - Test with malformed YAML
  - Assert returns False
- [ ] Write test: `test_validate_template_frontmatter_missing_required_fields()`
  - Test with YAML missing 'name' or 'description' or 'fields'
  - Assert returns False
- [ ] Run tests: `uv run pytest tests/unit/validators/test_template_validator.py`
  - All should fail âœ“ (code doesn't exist yet)

- [ ] Create `tests/unit/templates/test_template_loader.py`
- [ ] Write test: `test_load_template_project_override(tmp_path)`
  - Mock project template at `.gitstory/templates/story.md`
  - Assert loads project template (highest priority)
- [ ] Write test: `test_load_template_user_override(tmp_path)`
  - Mock user template at `~/.claude/skills/gitstory/templates/story.md`
  - No project template exists
  - Assert loads user template
- [ ] Write test: `test_load_template_skill_default(tmp_path)`
  - No project or user templates exist
  - Mock skill template at `{baseDir}/templates/story.md`
  - Assert loads skill template (lowest priority)
- [ ] Write test: `test_load_template_not_found()`
  - Template doesn't exist at any level
  - Assert raises FileNotFoundError with helpful message
- [ ] Run tests: `uv run pytest tests/unit/templates/test_template_loader.py`
  - All should fail âœ“ (code doesn't exist yet)

### Implementation (GREEN)

- [ ] Create `src/gitstory/validators/template_validator.py`
- [ ] Implement `validate_template_frontmatter(template_path: Path) -> bool`:
  - Read template file content
  - Check starts with `---`
  - Split on `---` to extract frontmatter
  - Parse with `yaml.safe_load()`
  - Validate required fields: name, description, fields
  - Validate fields is a list
  - Return True if valid, False otherwise
  - Handle yaml.YAMLError exceptions

- [ ] Create `src/gitstory/templates/template_loader.py`
- [ ] Implement `load_template(template_name: str) -> dict`:
  - Check project override: `.gitstory/templates/{template_name}.md`
  - If exists, parse and return
  - Check user override: `~/.claude/skills/gitstory/templates/{template_name}.md`
  - If exists, parse and return
  - Check skill default: `{baseDir}/templates/{template_name}.md`
  - If exists, parse and return
  - If none exist, raise FileNotFoundError with helpful message

- [ ] Implement `parse_template(template_path: Path) -> dict`:
  - Read template file
  - Split frontmatter and body
  - Parse YAML frontmatter
  - Return dict with: frontmatter (dict), body (string), path (Path)

- [ ] Run validator tests: `uv run pytest tests/unit/validators/test_template_validator.py`
  - All should pass âœ“
- [ ] Run loader tests: `uv run pytest tests/unit/templates/test_template_loader.py`
  - All should pass âœ“

### Refactor

- [ ] Add type hints to all functions
- [ ] Add docstrings with examples
- [ ] Extract constants (template paths, field names)
- [ ] Add error messages with context
- [ ] Run mypy: `uv run mypy src/gitstory/`
- [ ] Run ruff: `uv run ruff check src/ tests/`

### Integration Validation

- [ ] Verify template lookup priority works end-to-end:
  ```python
  # Manual test script
  from gitstory.templates.template_loader import load_template

  # Should load from skills/gitstory/templates/story.md
  template = load_template("story")
  print(f"Loaded: {template['path']}")
  print(f"Fields: {len(template['frontmatter']['fields'])}")
  ```

- [ ] Verify all 6 templates validate correctly:
  ```python
  from pathlib import Path
  from gitstory.validators.template_validator import validate_template_frontmatter

  templates_dir = Path("skills/gitstory/templates")
  for template_file in templates_dir.glob("*.md"):
    valid = validate_template_frontmatter(template_file)
    print(f"{template_file.name}: {'âœ“' if valid else 'âœ—'}")
  ```

### Final Verification

- [ ] All unit tests pass: `uv run pytest tests/unit/validators/ tests/unit/templates/`
- [ ] Type checking passes: `uv run mypy src/gitstory/`
- [ ] Linting passes: `uv run ruff check src/ tests/`
- [ ] Code coverage >80%: `uv run pytest --cov=src/gitstory --cov-report=term-missing`
- [ ] All 6 templates validate successfully

## Files to Create/Modify

- **CREATE**: `src/gitstory/validators/template_validator.py` (~60 lines, YAML validation logic)
- **CREATE**: `src/gitstory/templates/template_loader.py` (~80 lines, priority lookup + parsing)
- **CREATE**: `tests/unit/validators/test_template_validator.py` (~120 lines, 5+ tests)
- **CREATE**: `tests/unit/templates/test_template_loader.py` (~150 lines, 6+ tests)
- **CREATE**: `src/gitstory/templates/__init__.py` (empty, package marker)
- **CREATE**: `tests/unit/validators/__init__.py` (empty, package marker)
- **CREATE**: `tests/unit/templates/__init__.py` (empty, package marker)

## Pattern Reuse

- YAML validation pattern from `src/gitstory/validators/yaml_validator.py` (created in STORY-0001.1.1)
- Unit test patterns from `tests/test_yaml_validator.py` (created in STORY-0001.1.1)
- TDD workflow: Red (failing tests) â†’ Green (minimal implementation) â†’ Refactor

## Dependencies

- TASK-0001.1.4.1 complete: All 6 templates created and YAML-valid
- STORY-0001.1.1 complete: pytest infrastructure and yaml_validator pattern
- Python 3.12+ with PyYAML, pytest, mypy, ruff

## Notes

**Testing strategy**: Per TESTING.md, Python code gets unit tests. This task implements TDD:
1. Write failing unit tests (RED)
2. Implement minimal code to pass (GREEN)
3. Refactor for quality (REFACTOR)

**Priority lookup**: The lookup order (project â†’ user â†’ skill) matches the pattern documented in story README lines 116-135. This will be used by planning commands in EPIC-0001.3.

**Coverage goal**: >80% for all Python code per TESTING.md. Template loader and validator should have comprehensive test coverage.

**Integration note**: This code provides infrastructure for EPIC-0001.3 (Workflow Plugins & Universal Commands). Templates will be used by `/gitstory:plan` command.
